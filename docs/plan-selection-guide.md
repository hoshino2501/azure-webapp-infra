# プラン選定ガイド

各コンポーネントのプラン選定基準と、環境ごとの推奨設定をまとめたドキュメントです。

---

## App Service Plan

### SKU 比較

| SKU | vCPU | RAM | Always On | VNet 統合 | オートスケール | SLA | 月額目安 |
|-----|------|-----|-----------|-----------|--------------|-----|---------|
| B1  | 1    | 1.75 GB | 不可 | **不可** | 不可 | なし | ~$13 |
| B2  | 2    | 3.5 GB  | 可  | 可       | 不可 | なし | ~$26 |
| B3  | 4    | 7 GB    | 可  | 可       | 不可 | なし | ~$52 |
| P0v3 | 1  | 4 GB    | 可  | 可       | 可   | 99.95% | ~$38 |
| P1v3 | 2  | 8 GB    | 可  | 可       | 可   | 99.95% | ~$75 |
| P2v3 | 4  | 16 GB   | 可  | 可       | 可   | 99.95% | ~$150 |

> 月額目安は japaneast リージョンの概算です。実際の料金は [Azure 料金計算ツール](https://azure.microsoft.com/ja-jp/pricing/calculator/) で確認してください。

### 制約事項

- **B1 は VNet 統合不可。** このプロジェクトは App Service に VNet 統合 (`virtual_network_subnet_id`) を使用しているため、B1 は使用できません。最低 B2 以上が必要です。
- **Always On は B2 以上または P シリーズで有効化可能。** B1 では `always_on = false` にする必要があります。
- **オートスケールが必要な場合は P シリーズ必須。**

### 選定基準

| 条件 | 推奨 SKU |
|------|---------|
| 開発・動作確認のみ、負荷低 | B2 |
| ステージング、SLA 不要、負荷低〜中 | P0v3 |
| 本番、SLA 必要、同時接続 〜数百 | P1v3 |
| 本番、高トラフィック、メモリ集約型アプリ | P2v3 以上 |

### 環境別設定

| 環境 | SKU | 理由 |
|------|-----|------|
| dev | `B2` | VNet 統合に必要な最小 SKU。開発用途のため低コストを優先 |
| staging | `P0v3` | SLA・オートスケール対応。P シリーズ最小構成 |
| prod | `P1v3` | 本番 SLA (99.95%)、2 vCPU / 8 GB RAM で中規模まで対応 |

---

## PostgreSQL Flexible Server

### SKU 比較

| SKU | vCPU | RAM | バースト | HA 対応 | 月額目安 |
|-----|------|-----|---------|---------|---------|
| B_Standard_B1ms | 1 (バースト) | 2 GB | あり | **不可** | ~$13 |
| B_Standard_B2ms | 2 (バースト) | 4 GB | あり | **不可** | ~$26 |
| B_Standard_B4ms | 4 (バースト) | 8 GB | あり | **不可** | ~$52 |
| GP_Standard_D2s_v3 | 2 | 8 GB | なし | 可 | ~$130 |
| GP_Standard_D4s_v3 | 4 | 16 GB | なし | 可 | ~$260 |
| GP_Standard_D8s_v3 | 8 | 32 GB | なし | 可 | ~$520 |

> 月額目安はストレージ 32 GB、japaneast リージョンの概算です。

### シリーズの特性

**Burstable (B シリーズ)**
- CPU クレジット方式でバースト可能。平均 CPU 使用率が低い用途に最適
- HA (High Availability) は使用不可
- 開発・テスト・アクセス頻度の低い本番に適する

**General Purpose (GP シリーズ)**
- vCPU を常時フルに使用可能
- HA 構成 (同一ゾーン / ゾーン冗長) が利用可能
- 本番環境や常時高負荷なワークロードに適する

### 選定基準

| 条件 | 推奨 SKU |
|------|---------|
| 開発・動作確認のみ | B_Standard_B1ms |
| ステージング、常時高負荷でない | B_Standard_B2ms |
| 本番、HA 不要、中規模 | GP_Standard_D2s_v3 |
| 本番、HA 必要 または 高負荷 | GP_Standard_D2s_v3 以上 + HA 有効化 |
| 本番、大規模・高同時接続 | GP_Standard_D4s_v3 以上 |

同時接続数の目安:

| SKU | 推奨最大同時接続数 |
|-----|-----------------|
| B_Standard_B1ms | ~50 |
| B_Standard_B2ms | ~100 |
| GP_Standard_D2s_v3 | ~200 |
| GP_Standard_D4s_v3 | ~400 |

### 環境別設定

| 環境 | SKU | geo冗長バックアップ | バックアップ保持 | 理由 |
|------|-----|--------------------|----------------|------|
| dev | `B_Standard_B1ms` | 無効 | 7日 | 最小コスト。開発用途 |
| staging | `B_Standard_B2ms` | 無効 | 7日 | 機能確認用。HA 不要 |
| prod | `GP_Standard_D2s_v3` | 有効 | 35日 | 本番 SLA、HA 対応可能な GP シリーズ |

> **staging で HA が必要になった場合:** `B_Standard_B2ms` → `GP_Standard_D2s_v3` に変更し、`high_availability` ブロックを追加してください。

---

## スケールアップの判断基準

以下の状況が継続する場合はプランのスケールアップを検討してください。

### App Service

| 指標 | しきい値 | 対応 |
|------|---------|------|
| CPU 使用率 | 平均 70% 以上 (15分) | 上位 SKU へ変更 |
| メモリ使用率 | 平均 80% 以上 | 上位 SKU へ変更 |
| レスポンスタイム | p95 が 2秒 以上 | オートスケールまたは上位 SKU |
| HTTP 5xx エラー率 | 1% 以上 | 原因調査 + スケールアップ検討 |

### PostgreSQL

| 指標 | しきい値 | 対応 |
|------|---------|------|
| CPU 使用率 | 平均 80% 以上 (15分) | 上位 SKU へ変更 |
| メモリ使用率 | 平均 85% 以上 | 上位 SKU へ変更 |
| 接続数 | 最大接続数の 80% 以上 | 上位 SKU またはコネクションプーラー導入 |
| ストレージ使用率 | 70% 以上 | ストレージ拡張 (`storage_mb` を増やす) |

これらの指標は Azure Monitor + Log Analytics で監視できます。アラートの設定は `modules/log_analytics` と組み合わせて構成してください。
